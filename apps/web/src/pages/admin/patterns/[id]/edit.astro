---
import AdminLayout from "../../../../layouts/AdminLayout.astro";

const { id } = Astro.params;
const API_URL = import.meta.env.API_URL ?? "http://localhost:8787";
const cookie = Astro.request.headers.get("cookie") ?? "";

// Fetch pattern
let pattern: {
  id: string;
  name: string;
  vendor: string;
  category: string;
  urlPatterns: string[];
  globalVariables: string[];
  knownIssues: string[];
  alternatives: string[];
  docsUrl: string | null;
} | null = null;
let error = "";

try {
  const response = await fetch(`${API_URL}/admin/patterns/${id}`, {
    headers: { cookie },
    credentials: "include",
  });

  if (response.ok) {
    const data = await response.json();
    pattern = data.pattern;
  } else {
    const data = await response.json();
    error = data.error ?? "Pattern not found";
  }
} catch (e) {
  error = "Failed to connect to API";
}

if (!pattern && !error) {
  return Astro.redirect("/admin/patterns");
}

const categories = [
  { value: "analytics", label: "Analytics" },
  { value: "advertising", label: "Advertising" },
  { value: "social", label: "Social" },
  { value: "customer-support", label: "Customer Support" },
  { value: "ab-testing", label: "A/B Testing" },
  { value: "tag-manager", label: "Tag Manager" },
  { value: "cdn", label: "CDN" },
  { value: "fonts", label: "Fonts" },
  { value: "video", label: "Video" },
  { value: "other", label: "Other" },
];
---

<AdminLayout title={pattern ? `Edit ${pattern.name}` : "Edit Pattern"}>
  <div class="max-w-2xl">
    <div class="mb-8">
      <a href="/admin/patterns" class="text-zinc-400 hover:text-white text-sm mb-2 inline-flex items-center gap-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        Back to patterns
      </a>
      <h1 class="text-3xl font-bold">Edit Pattern</h1>
    </div>

    {error ? (
      <div class="card bg-red-900/20 border-red-800">
        <p class="text-red-400">{error}</p>
        <a href="/admin/patterns" class="btn-secondary mt-4 inline-block">Back to patterns</a>
      </div>
    ) : pattern && (
      <form id="pattern-form" class="card space-y-6" data-id={pattern.id}>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-zinc-300 mb-1">ID</label>
            <input
              type="text"
              value={pattern.id}
              disabled
              class="input w-full font-mono bg-zinc-800 cursor-not-allowed"
            />
            <p class="text-xs text-zinc-500 mt-1">ID cannot be changed</p>
          </div>
          <div>
            <label for="category" class="block text-sm font-medium text-zinc-300 mb-1">
              Category <span class="text-red-400">*</span>
            </label>
            <select id="category" name="category" required class="input w-full">
              {categories.map((cat) => (
                <option value={cat.value} selected={pattern.category === cat.value}>
                  {cat.label}
                </option>
              ))}
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="name" class="block text-sm font-medium text-zinc-300 mb-1">
              Name <span class="text-red-400">*</span>
            </label>
            <input
              type="text"
              id="name"
              name="name"
              required
              value={pattern.name}
              class="input w-full"
            />
          </div>
          <div>
            <label for="vendor" class="block text-sm font-medium text-zinc-300 mb-1">
              Vendor <span class="text-red-400">*</span>
            </label>
            <input
              type="text"
              id="vendor"
              name="vendor"
              required
              value={pattern.vendor}
              class="input w-full"
            />
          </div>
        </div>

        <div>
          <label for="urlPatterns" class="block text-sm font-medium text-zinc-300 mb-1">
            URL Patterns <span class="text-red-400">*</span>
          </label>
          <textarea
            id="urlPatterns"
            name="urlPatterns"
            required
            rows="3"
            class="input w-full font-mono text-sm"
          >{pattern.urlPatterns?.join("\n")}</textarea>
          <p class="text-xs text-zinc-500 mt-1">One pattern per line. Use * as wildcard.</p>
        </div>

        <div>
          <label for="globalVariables" class="block text-sm font-medium text-zinc-300 mb-1">
            Global Variables
          </label>
          <input
            type="text"
            id="globalVariables"
            name="globalVariables"
            value={pattern.globalVariables?.join(", ")}
            class="input w-full font-mono"
          />
          <p class="text-xs text-zinc-500 mt-1">Comma-separated list of global JS variables</p>
        </div>

        <div>
          <label for="knownIssues" class="block text-sm font-medium text-zinc-300 mb-1">
            Known Issues
          </label>
          <textarea
            id="knownIssues"
            name="knownIssues"
            rows="2"
            class="input w-full text-sm"
          >{pattern.knownIssues?.join("\n")}</textarea>
          <p class="text-xs text-zinc-500 mt-1">One issue per line</p>
        </div>

        <div>
          <label for="alternatives" class="block text-sm font-medium text-zinc-300 mb-1">
            Alternatives
          </label>
          <input
            type="text"
            id="alternatives"
            name="alternatives"
            value={pattern.alternatives?.join(", ")}
            class="input w-full"
          />
          <p class="text-xs text-zinc-500 mt-1">Comma-separated list of alternatives</p>
        </div>

        <div>
          <label for="docsUrl" class="block text-sm font-medium text-zinc-300 mb-1">
            Documentation URL
          </label>
          <input
            type="url"
            id="docsUrl"
            name="docsUrl"
            value={pattern.docsUrl ?? ""}
            class="input w-full"
          />
        </div>

        <div id="error-message" class="hidden text-red-400 text-sm"></div>

        <div class="flex gap-4 justify-between">
          <div class="flex gap-4">
            <button type="submit" class="btn-primary" id="submit-btn">
              Save Changes
            </button>
            <a href="/admin/patterns" class="btn-secondary">Cancel</a>
          </div>
          <button type="button" class="text-red-400 hover:text-red-300 text-sm" id="delete-btn">
            Delete Pattern
          </button>
        </div>
      </form>
    )}
  </div>
</AdminLayout>

<script>
  const API_URL = import.meta.env.PUBLIC_API_URL ?? "http://localhost:8787";

  const form = document.getElementById("pattern-form") as HTMLFormElement;
  const errorMessage = document.getElementById("error-message");
  const submitBtn = document.getElementById("submit-btn");
  const deleteBtn = document.getElementById("delete-btn");
  const patternId = form?.dataset.id;

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form);

    const data = {
      name: formData.get("name"),
      vendor: formData.get("vendor"),
      category: formData.get("category"),
      urlPatterns: (formData.get("urlPatterns") as string)
        .split("\n")
        .map((s) => s.trim())
        .filter(Boolean),
      globalVariables: (formData.get("globalVariables") as string)
        .split(",")
        .map((s) => s.trim())
        .filter(Boolean),
      knownIssues: (formData.get("knownIssues") as string)
        .split("\n")
        .map((s) => s.trim())
        .filter(Boolean),
      alternatives: (formData.get("alternatives") as string)
        .split(",")
        .map((s) => s.trim())
        .filter(Boolean),
      docsUrl: formData.get("docsUrl") || null,
    };

    submitBtn.disabled = true;
    submitBtn.textContent = "Saving...";
    errorMessage.classList.add("hidden");

    try {
      const response = await fetch(`${API_URL}/admin/patterns/${patternId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
        credentials: "include",
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error ?? "Failed to save pattern");
      }

      // Redirect to patterns list
      window.location.href = "/admin/patterns";
    } catch (err) {
      errorMessage.textContent = err.message;
      errorMessage.classList.remove("hidden");
      submitBtn.disabled = false;
      submitBtn.textContent = "Save Changes";
    }
  });

  deleteBtn?.addEventListener("click", async () => {
    if (!confirm("Are you sure you want to delete this pattern?")) {
      return;
    }

    try {
      const response = await fetch(`${API_URL}/admin/patterns/${patternId}`, {
        method: "DELETE",
        credentials: "include",
      });

      if (!response.ok) {
        const result = await response.json();
        throw new Error(result.error ?? "Failed to delete pattern");
      }

      window.location.href = "/admin/patterns";
    } catch (err) {
      alert(err.message);
    }
  });
</script>
