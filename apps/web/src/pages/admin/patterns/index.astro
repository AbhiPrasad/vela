---
import AdminLayout from "../../../layouts/AdminLayout.astro";

const API_URL = import.meta.env.API_URL ?? "http://localhost:8787";
const cookie = Astro.request.headers.get("cookie") ?? "";

// Get query params
const page = parseInt(Astro.url.searchParams.get("page") ?? "1");
const category = Astro.url.searchParams.get("category") ?? "";
const search = Astro.url.searchParams.get("search") ?? "";
const limit = 20;
const offset = (page - 1) * limit;

// Build URL
let apiUrl = `${API_URL}/admin/patterns?limit=${limit}&offset=${offset}`;
if (category) apiUrl += `&category=${encodeURIComponent(category)}`;
if (search) apiUrl += `&search=${encodeURIComponent(search)}`;

// Fetch patterns
let patterns: Array<{
  id: string;
  name: string;
  vendor: string;
  category: string;
  urlPatterns: string[];
}> = [];
let total = 0;
let error = "";

try {
  const response = await fetch(apiUrl, {
    headers: { cookie },
    credentials: "include",
  });

  if (response.ok) {
    const data = await response.json();
    patterns = data.patterns ?? [];
    total = data.pagination?.total ?? 0;
  } else {
    const data = await response.json();
    error = data.error ?? "Failed to fetch patterns";
  }
} catch (e) {
  error = "Failed to connect to API";
}

const totalPages = Math.ceil(total / limit);

// Categories for filter
const categories = [
  "analytics",
  "advertising",
  "social",
  "customer-support",
  "ab-testing",
  "tag-manager",
  "cdn",
  "fonts",
  "video",
  "other",
];
---

<AdminLayout title="Patterns">
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-3xl font-bold mb-2">Script Patterns</h1>
      <p class="text-zinc-400">Manage third-party script detection patterns</p>
    </div>
    <a href="/admin/patterns/new" class="btn-primary">
      Add Pattern
    </a>
  </div>

  <!-- Filters -->
  <div class="card mb-6">
    <form method="get" class="flex gap-4 items-end">
      <div class="flex-1">
        <label for="search" class="block text-sm font-medium text-zinc-400 mb-1">Search</label>
        <input
          type="text"
          id="search"
          name="search"
          value={search}
          placeholder="Search by name or vendor..."
          class="input w-full"
        />
      </div>
      <div class="w-48">
        <label for="category" class="block text-sm font-medium text-zinc-400 mb-1">Category</label>
        <select id="category" name="category" class="input w-full">
          <option value="">All categories</option>
          {categories.map((cat) => (
            <option value={cat} selected={category === cat}>
              {cat.replace("-", " ")}
            </option>
          ))}
        </select>
      </div>
      <button type="submit" class="btn-secondary">Filter</button>
      {(search || category) && (
        <a href="/admin/patterns" class="btn-secondary">Clear</a>
      )}
    </form>
  </div>

  {error ? (
    <div class="card bg-red-900/20 border-red-800">
      <p class="text-red-400">{error}</p>
    </div>
  ) : patterns.length === 0 ? (
    <div class="card text-center py-12">
      <p class="text-zinc-400 mb-4">No patterns found</p>
      <a href="/admin/patterns/new" class="btn-primary">Add your first pattern</a>
    </div>
  ) : (
    <>
      <div class="card overflow-hidden p-0">
        <table class="w-full">
          <thead class="bg-zinc-800">
            <tr>
              <th class="text-left px-4 py-3 text-sm font-medium text-zinc-400">Name</th>
              <th class="text-left px-4 py-3 text-sm font-medium text-zinc-400">Vendor</th>
              <th class="text-left px-4 py-3 text-sm font-medium text-zinc-400">Category</th>
              <th class="text-left px-4 py-3 text-sm font-medium text-zinc-400">Patterns</th>
              <th class="px-4 py-3"></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-zinc-800">
            {patterns.map((pattern) => (
              <tr class="hover:bg-zinc-800/50">
                <td class="px-4 py-3">
                  <span class="font-medium">{pattern.name}</span>
                  <span class="block text-xs text-zinc-500 font-mono">{pattern.id}</span>
                </td>
                <td class="px-4 py-3 text-zinc-400">{pattern.vendor}</td>
                <td class="px-4 py-3">
                  <span class="inline-block px-2 py-1 text-xs rounded bg-zinc-800 text-zinc-300">
                    {pattern.category}
                  </span>
                </td>
                <td class="px-4 py-3 text-zinc-500 text-sm">
                  {pattern.urlPatterns?.length ?? 0} pattern(s)
                </td>
                <td class="px-4 py-3 text-right">
                  <a
                    href={`/admin/patterns/${pattern.id}/edit`}
                    class="text-blue-400 hover:text-blue-300 text-sm"
                  >
                    Edit
                  </a>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      {totalPages > 1 && (
        <div class="flex items-center justify-between mt-4">
          <p class="text-sm text-zinc-500">
            Showing {offset + 1} to {Math.min(offset + limit, total)} of {total} patterns
          </p>
          <div class="flex gap-2">
            {page > 1 && (
              <a
                href={`/admin/patterns?page=${page - 1}${category ? `&category=${category}` : ""}${search ? `&search=${search}` : ""}`}
                class="btn-secondary text-sm"
              >
                Previous
              </a>
            )}
            {page < totalPages && (
              <a
                href={`/admin/patterns?page=${page + 1}${category ? `&category=${category}` : ""}${search ? `&search=${search}` : ""}`}
                class="btn-secondary text-sm"
              >
                Next
              </a>
            )}
          </div>
        </div>
      )}
    </>
  )}
</AdminLayout>
