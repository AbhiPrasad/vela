---
import AdminLayout from "../../../layouts/AdminLayout.astro";

const API_URL = import.meta.env.API_URL ?? "http://localhost:8787";
const cookie = Astro.request.headers.get("cookie") ?? "";

// Get query params
const page = parseInt(Astro.url.searchParams.get("page") ?? "1");
const category = Astro.url.searchParams.get("category") ?? "";
const search = Astro.url.searchParams.get("search") ?? "";
const limit = 20;
const offset = (page - 1) * limit;

// Build URL
let apiUrl = `${API_URL}/admin/patterns?limit=${limit}&offset=${offset}`;
if (category) apiUrl += `&category=${encodeURIComponent(category)}`;
if (search) apiUrl += `&search=${encodeURIComponent(search)}`;

// Fetch patterns
let patterns: Array<{
  id: string;
  name: string;
  vendor: string;
  category: string;
  urlPatterns: string[];
}> = [];
let total = 0;
let error = "";

try {
  const response = await fetch(apiUrl, {
    headers: { cookie },
    credentials: "include",
  });

  if (response.ok) {
    const data = await response.json();
    patterns = data.patterns ?? [];
    total = data.pagination?.total ?? 0;
  } else {
    const data = await response.json();
    error = data.error ?? "Failed to fetch patterns";
  }
} catch (e) {
  error = "Failed to connect to API";
}

const totalPages = Math.ceil(total / limit);

// Categories for filter
const categories = [
  "analytics",
  "advertising",
  "social",
  "customer-support",
  "ab-testing",
  "tag-manager",
  "cdn",
  "fonts",
  "video",
  "other",
];
---

<AdminLayout title="Patterns">
  <div class="flex items-center justify-between mb-8">
    <div>
      <span class="text-xs text-gray-600 uppercase tracking-[0.3em] font-mono">// pattern management</span>
      <h1 class="text-3xl font-bold mt-2 text-neon-orange">Script Patterns</h1>
      <p class="text-gray-500 font-mono text-sm mt-1">Manage third-party script detection patterns</p>
    </div>
    <a href="/admin/patterns/new" class="bg-neon-orange text-cyber-black font-bold px-6 py-2.5 uppercase tracking-wider border border-neon-orange hover:shadow-neon-orange transition-all duration-200">
      Add Pattern
    </a>
  </div>

  <!-- Filters -->
  <div class="bg-cyber-darker border border-cyber-light p-4 mb-6">
    <form method="get" class="flex gap-4 items-end">
      <div class="flex-1">
        <label for="search" class="block text-xs font-medium text-gray-500 mb-2 uppercase tracking-wider">Search</label>
        <input
          type="text"
          id="search"
          name="search"
          value={search}
          placeholder="Search by name or vendor..."
          class="w-full bg-cyber-dark border border-cyber-light px-4 py-2 text-gray-100 placeholder:text-gray-600 focus:outline-none focus:border-neon-cyan focus:shadow-neon-cyan transition-all duration-200 font-mono"
        />
      </div>
      <div class="w-48">
        <label for="category" class="block text-xs font-medium text-gray-500 mb-2 uppercase tracking-wider">Category</label>
        <select id="category" name="category" class="w-full bg-cyber-dark border border-cyber-light px-4 py-2 text-gray-100 focus:outline-none focus:border-neon-cyan transition-all duration-200">
          <option value="">All categories</option>
          {categories.map((cat) => (
            <option value={cat} selected={category === cat}>
              {cat.replace("-", " ")}
            </option>
          ))}
        </select>
      </div>
      <button type="submit" class="bg-transparent text-neon-cyan font-medium px-4 py-2 border border-neon-cyan/50 hover:border-neon-cyan hover:shadow-neon-cyan hover:bg-neon-cyan/10 transition-all duration-200 uppercase tracking-wide text-sm">
        Filter
      </button>
      {(search || category) && (
        <a href="/admin/patterns" class="bg-transparent text-gray-400 font-medium px-4 py-2 border border-cyber-light hover:text-neon-orange hover:border-neon-orange/50 transition-all duration-200 uppercase tracking-wide text-sm">
          Clear
        </a>
      )}
    </form>
  </div>

  {error ? (
    <div class="bg-cyber-darker border border-neon-red p-4">
      <p class="text-neon-red font-mono">// ERROR: {error}</p>
    </div>
  ) : patterns.length === 0 ? (
    <div class="bg-cyber-darker border border-cyber-light text-center py-12">
      <p class="text-gray-500 mb-4 font-mono">// No patterns found</p>
      <a href="/admin/patterns/new" class="inline-block bg-neon-orange text-cyber-black font-bold px-6 py-2.5 uppercase tracking-wider border border-neon-orange hover:shadow-neon-orange transition-all duration-200">
        Add your first pattern
      </a>
    </div>
  ) : (
    <>
      <div class="bg-cyber-darker border border-cyber-light overflow-hidden">
        <table class="w-full">
          <thead class="bg-cyber-dark border-b border-cyber-light">
            <tr>
              <th class="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
              <th class="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor</th>
              <th class="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
              <th class="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Patterns</th>
              <th class="px-4 py-3"></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-cyber-light/50">
            {patterns.map((pattern) => (
              <tr class="hover:bg-cyber-dark/50 transition-colors">
                <td class="px-4 py-3">
                  <span class="font-medium text-gray-100">{pattern.name}</span>
                  <span class="block text-xs text-gray-600 font-mono mt-0.5">{pattern.id}</span>
                </td>
                <td class="px-4 py-3 text-gray-400 font-mono text-sm">{pattern.vendor}</td>
                <td class="px-4 py-3">
                  <span class="inline-block px-2 py-1 text-xs border border-neon-cyan/50 text-neon-cyan uppercase tracking-wide">
                    {pattern.category}
                  </span>
                </td>
                <td class="px-4 py-3 text-gray-500 text-sm font-mono">
                  {pattern.urlPatterns?.length ?? 0} pattern(s)
                </td>
                <td class="px-4 py-3 text-right">
                  <a
                    href={`/admin/patterns/${pattern.id}/edit`}
                    class="text-neon-amber hover:text-neon-orange text-sm uppercase tracking-wide transition-colors"
                  >
                    Edit
                  </a>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      {totalPages > 1 && (
        <div class="flex items-center justify-between mt-4">
          <p class="text-sm text-gray-600 font-mono">
            // Showing {offset + 1} to {Math.min(offset + limit, total)} of {total} patterns
          </p>
          <div class="flex gap-2">
            {page > 1 && (
              <a
                href={`/admin/patterns?page=${page - 1}${category ? `&category=${category}` : ""}${search ? `&search=${search}` : ""}`}
                class="bg-transparent text-gray-400 font-medium px-4 py-2 border border-cyber-light hover:text-neon-cyan hover:border-neon-cyan/50 transition-all duration-200 uppercase tracking-wide text-sm"
              >
                Previous
              </a>
            )}
            {page < totalPages && (
              <a
                href={`/admin/patterns?page=${page + 1}${category ? `&category=${category}` : ""}${search ? `&search=${search}` : ""}`}
                class="bg-transparent text-gray-400 font-medium px-4 py-2 border border-cyber-light hover:text-neon-cyan hover:border-neon-cyan/50 transition-all duration-200 uppercase tracking-wide text-sm"
              >
                Next
              </a>
            )}
          </div>
        </div>
      )}
    </>
  )}
</AdminLayout>
