---
import AdminLayout from "../../../layouts/AdminLayout.astro";

const user = Astro.locals.user;

// Only admins can access this page
if (user?.role !== "admin") {
  return new Response("Forbidden", { status: 403 });
}

const API_URL = import.meta.env.API_URL ?? "http://localhost:8787";
const cookie = Astro.request.headers.get("cookie") ?? "";

// Fetch users
let users: Array<{
  id: string;
  email: string;
  name: string | null;
  role: string;
  emailVerified: boolean;
  createdAt: string;
}> = [];
let error = "";

try {
  const response = await fetch(`${API_URL}/admin/users`, {
    headers: { cookie },
    credentials: "include",
  });

  if (response.ok) {
    const data = await response.json();
    users = data.users ?? [];
  } else {
    const data = await response.json();
    error = data.error ?? "Failed to fetch users";
  }
} catch (e) {
  error = "Failed to connect to API";
}
---

<AdminLayout title="Users">
  <div class="mb-8">
    <h1 class="text-3xl font-bold mb-2">User Management</h1>
    <p class="text-zinc-400">Manage admin and editor accounts</p>
  </div>

  {error ? (
    <div class="card bg-red-900/20 border-red-800">
      <p class="text-red-400">{error}</p>
    </div>
  ) : users.length === 0 ? (
    <div class="card text-center py-12">
      <p class="text-zinc-400">No users found</p>
    </div>
  ) : (
    <div class="card overflow-hidden p-0">
      <table class="w-full">
        <thead class="bg-zinc-800">
          <tr>
            <th class="text-left px-4 py-3 text-sm font-medium text-zinc-400">User</th>
            <th class="text-left px-4 py-3 text-sm font-medium text-zinc-400">Role</th>
            <th class="text-left px-4 py-3 text-sm font-medium text-zinc-400">Status</th>
            <th class="px-4 py-3"></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-zinc-800">
          {users.map((u) => (
            <tr class="hover:bg-zinc-800/50">
              <td class="px-4 py-3">
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 bg-zinc-700 rounded-full flex items-center justify-center text-sm">
                    {u.name?.charAt(0).toUpperCase() ?? u.email?.charAt(0).toUpperCase()}
                  </div>
                  <div>
                    <span class="font-medium">{u.name ?? "No name"}</span>
                    <span class="block text-sm text-zinc-500">{u.email}</span>
                  </div>
                </div>
              </td>
              <td class="px-4 py-3">
                <select
                  class="input py-1 text-sm"
                  data-user-id={u.id}
                  data-current-role={u.role}
                  disabled={u.id === user?.id}
                >
                  <option value="user" selected={u.role === "user"}>User</option>
                  <option value="editor" selected={u.role === "editor"}>Editor</option>
                  <option value="admin" selected={u.role === "admin"}>Admin</option>
                </select>
              </td>
              <td class="px-4 py-3">
                <span class:list={[
                  "inline-flex items-center gap-1 text-xs px-2 py-1 rounded",
                  u.emailVerified ? "bg-green-900/30 text-green-400" : "bg-yellow-900/30 text-yellow-400"
                ]}>
                  {u.emailVerified ? (
                    <>
                      <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                      </svg>
                      Verified
                    </>
                  ) : (
                    <>
                      <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                      </svg>
                      Pending
                    </>
                  )}
                </span>
              </td>
              <td class="px-4 py-3 text-right">
                {u.id !== user?.id && (
                  <button
                    class="text-red-400 hover:text-red-300 text-sm delete-user-btn"
                    data-user-id={u.id}
                    data-user-email={u.email}
                  >
                    Delete
                  </button>
                )}
                {u.id === user?.id && (
                  <span class="text-zinc-500 text-sm">You</span>
                )}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  )}
</AdminLayout>

<script>
  const API_URL = import.meta.env.PUBLIC_API_URL ?? "http://localhost:8787";

  // Role change handlers
  document.querySelectorAll("select[data-user-id]").forEach((select) => {
    select.addEventListener("change", async (e) => {
      const target = e.target as HTMLSelectElement;
      const userId = target.dataset.userId;
      const newRole = target.value;

      try {
        const response = await fetch(`${API_URL}/admin/users/${userId}/role`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ role: newRole }),
          credentials: "include",
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error ?? "Failed to update role");
        }

        // Success - the select already shows the new value
      } catch (err) {
        alert(err.message);
        // Revert to previous value
        target.value = target.dataset.currentRole ?? "user";
      }
    });
  });

  // Delete handlers
  document.querySelectorAll(".delete-user-btn").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      const target = e.target as HTMLButtonElement;
      const userId = target.dataset.userId;
      const userEmail = target.dataset.userEmail;

      if (!confirm(`Are you sure you want to delete ${userEmail}?`)) {
        return;
      }

      try {
        const response = await fetch(`${API_URL}/admin/users/${userId}`, {
          method: "DELETE",
          credentials: "include",
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error ?? "Failed to delete user");
        }

        // Reload page
        window.location.reload();
      } catch (err) {
        alert(err.message);
      }
    });
  });
</script>
