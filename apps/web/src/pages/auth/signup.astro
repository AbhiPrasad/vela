---
import BaseLayout from "../../layouts/BaseLayout.astro";

// If already logged in, redirect
if (Astro.locals.user) {
  return Astro.redirect("/admin");
}
---

<BaseLayout title="Sign Up">
  <div class="mx-auto max-w-md px-4 py-16">
    <div class="card">
      <div class="text-center mb-8">
        <h1 class="text-2xl font-bold mb-2">Create an account</h1>
        <p class="text-zinc-400">Sign up to manage script patterns</p>
      </div>

      <form id="signup-form" class="space-y-4">
        <div>
          <label for="name" class="block text-sm font-medium text-zinc-300 mb-1">
            Name
          </label>
          <input
            type="text"
            id="name"
            name="name"
            required
            class="input w-full"
            placeholder="Your name"
          />
        </div>

        <div>
          <label for="email" class="block text-sm font-medium text-zinc-300 mb-1">
            Email
          </label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="input w-full"
            placeholder="you@example.com"
          />
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-zinc-300 mb-1">
            Password
          </label>
          <input
            type="password"
            id="password"
            name="password"
            required
            minlength="8"
            class="input w-full"
            placeholder="At least 8 characters"
          />
        </div>

        <div>
          <label for="confirmPassword" class="block text-sm font-medium text-zinc-300 mb-1">
            Confirm Password
          </label>
          <input
            type="password"
            id="confirmPassword"
            name="confirmPassword"
            required
            class="input w-full"
            placeholder="Confirm your password"
          />
        </div>

        <div id="error-message" class="hidden text-red-400 text-sm"></div>

        <button type="submit" class="btn-primary w-full" id="submit-btn">
          Create account
        </button>
      </form>

      <div class="relative my-6">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-zinc-700"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="bg-zinc-900 px-2 text-zinc-500">Or continue with</span>
        </div>
      </div>

      <button
        id="github-btn"
        class="btn-secondary w-full flex items-center justify-center gap-2"
      >
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.604-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.464-1.11-1.464-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z"/>
        </svg>
        GitHub
      </button>

      <p class="mt-6 text-center text-sm text-zinc-500">
        Already have an account?
        <a href="/auth/login" class="text-blue-400 hover:text-blue-300">
          Sign in
        </a>
      </p>
    </div>
  </div>
</BaseLayout>

<script>
  const API_URL = import.meta.env.PUBLIC_API_URL ?? "http://localhost:8787";

  const form = document.getElementById("signup-form");
  const errorMessage = document.getElementById("error-message");
  const submitBtn = document.getElementById("submit-btn");
  const githubBtn = document.getElementById("github-btn");

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = document.getElementById("name").value;
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const confirmPassword = document.getElementById("confirmPassword").value;

    if (password !== confirmPassword) {
      errorMessage.textContent = "Passwords do not match";
      errorMessage.classList.remove("hidden");
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = "Creating account...";
    errorMessage.classList.add("hidden");

    try {
      const response = await fetch(`${API_URL}/api/auth/sign-up/email`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, email, password }),
        credentials: "include",
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.message ?? "Failed to create account");
      }

      // Redirect to admin on success
      window.location.href = "/admin";
    } catch (err) {
      errorMessage.textContent = err.message;
      errorMessage.classList.remove("hidden");
      submitBtn.disabled = false;
      submitBtn.textContent = "Create account";
    }
  });

  githubBtn?.addEventListener("click", () => {
    window.location.href = `${API_URL}/api/auth/sign-in/social?provider=github&callbackURL=${encodeURIComponent(window.location.origin + "/admin")}`;
  });
</script>
